# Agent Share - Docker Compose Configuration
#
# To use pre-built image from GitHub Container Registry (recommended):
#   Uncomment the 'image:' line below and remove/comment the 'build:' section
#
# To build from source:
#   Keep the 'build:' section and remove/comment the 'image:' line

services:
  agent-share:
    # Use pre-built image (recommended for production)
    # image: ghcr.io/henricook/agent-share:latest

    # OR build from source (default for local development)
    build:
      context: .
      dockerfile: Dockerfile
    image: agent-share:latest
    container_name: agent-share
    restart: unless-stopped
    ports:
      - "8721:8721"
    environment:
      - NODE_ENV=production
      - PORT=8721
      - STORAGE_PATH=/app/storage
      - MAX_FILE_SIZE_MB=50
      - MAX_JSONL_LINES=10000000
      - CCLOGVIEWER_BIN_PATH=/app/bin/cclogviewer
      - CCLOGVIEWER_TIMEOUT_MS=60000
      - RATE_LIMIT_UPLOAD_WINDOW_MS=900000
      - RATE_LIMIT_UPLOAD_MAX=10
      - RATE_LIMIT_VIEW_WINDOW_MS=60000
      - RATE_LIMIT_VIEW_MAX=100
      - BASE_URL=http://localhost:8721
    volumes:
      # Named volume for persistent uploads (Docker manages permissions)
      - agent-share-data:/app/storage:rw
    networks:
      - agent-share-network
    security_opt:
      # Prevent privilege escalation
      - no-new-privileges:true
    cap_drop:
      # Drop all capabilities
      - ALL
    cap_add:
      # Only add necessary capabilities
      - NET_BIND_SERVICE
    read_only: false
    tmpfs:
      # Temporary filesystem for /tmp
      - /tmp:noexec,nosuid,size=100M
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:8721/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

volumes:
  agent-share-data:
    driver: local

networks:
  agent-share-network:
    driver: bridge
